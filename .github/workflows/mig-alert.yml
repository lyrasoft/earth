name: Migration Changes Alert

on:
    pull_request:
        types: [ opened, synchronize, reopened ]

jobs:
    migration-alerts:
        runs-on: ubuntu-latest
        permissions:
            pull-requests: write
            contents: read

        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: Check changed files (only latest push)
                id: changes
                uses: dorny/paths-filter@v3
                with:
                    filters: |
                        added_migrations:
                          - added: 'resources/migrations/**'
                        modified_migrations:
                          - modified: 'resources/migrations/**'
                          - deleted: 'resources/migrations/**'

            -   name: Comment warning if existing migrations were modified
                if: steps.changes.outputs.added_migrations == 'true' || steps.changes.outputs.modified_migrations == 'true'
                uses: actions/github-script@v7
                with:
                    script: |
                        const labelName = "Migration";
                        const warningTag = "[MIGRATION_WARNING]";
                        
                        const isAdded = "${{ steps.changes.outputs.added_migrations }}" === "true";
                        const isModified = "${{ steps.changes.outputs.modified_migrations }}" === "true";
                        
                        // Add label if not exists
                        try {
                            await github.rest.issues.addLabels({
                                owner: context.repo.owner,
                                repo: context.repo.repo,
                                issue_number: context.issue.number,
                                labels: [labelName]
                            });
                        } catch (e) {
                            console.log(`Label '${labelName}' not found. Skipping label.`);
                        }
                        
                        // Only comment if there are modified migrations, not for added ones
                        if (isModified) {
                            // To check if we've already commented
                            const { data: comments } = await github.rest.issues.listComments({
                                owner: context.repo.owner,
                                repo: context.repo.repo,
                                issue_number: context.issue.number,
                            });
                            const alreadyCommented = comments.some(comment =>
                                comment.body.includes(warningTag)
                            );
                            
                            if (!alreadyCommented) {
                                await github.rest.issues.createComment({
                                    issue_number: context.issue.number,
                                    owner: context.repo.owner,
                                    repo: context.repo.repo,
                                    body: `⚠️ ${warningTag} 這個 PR 修改了 \`resources/migrations/*\` 下的既有檔案，請確認測試站與正式站是否已 Freeze 資料結構。`
                                });
                            }
                        }
